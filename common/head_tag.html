<script type="text/discourse-plugin" version="0.8.18">

const { iconNode, convertIconClass } = require("discourse-common/lib/icon-library");
const h = require("virtual-dom").h;

let columnIcons = [
  settings.group_first_column_icon,
  settings.group_second_column_icon,
  settings.group_third_column_icon,
  settings.group_fourth_column_icon
];

api.createWidget("group_groupbanner-column-icon", {
  tagName: "div.icon",
  html(attrs) {
    let columnIcon = columnIcons[attrs.column];
    if(columnIcon.includes("http") || columnIcon.includes("/uploads/")) {
      return h("img.responsive-img", { src: columnIcon });
    } else {
      let covertedIcon = convertIconClass(columnIcons[attrs.column]);
      return iconNode(covertedIcon);
    }
  }
});

function setCurrentExpDate(cookieExpDate) {
  if($.cookie("group_groupbanner_closed")) {
    let closedCookie = JSON.parse($.cookie("group_groupbanner_closed"));
    if(closedCookie.name != settings.group_cookie_name) {
      $.removeCookie("group_groupbanner_closed", {path: '/'} );
    } else {
      $.cookie("group_groupbanner_closed", JSON.stringify(closedCookie), { expires: cookieExpDate, path: '/' });
    }
  }

  if($.cookie("group_groupbanner_collapsed")) {
    let collapsedCookie = JSON.parse($.cookie("group_groupbanner_collapsed"));
    if(collapsedCookie.name != settings.group_cookie_name) {
      $.removeCookie("group_groupbanner_collapsed", {path: '/'} );
    } else {
      $.cookie("group_groupbanner_collapsed", JSON.stringify(collapsedCookie), { expires: cookieExpDate, path: '/' });
    }
  }
}

function setupgroupbanner() {
  if($.cookie("group_groupbanner_closed")) {
    let closedCookie = JSON.parse($.cookie("group_groupbanner_closed"));
    if(closedCookie.closed == "true" && settings.group_dismissible) {
      $('.groupbanner-box').addClass("hidden");
    }
  }
  let collapsedCookie;
  if($.cookie("group_groupbanner_collapsed")) {
    collapsedCookie = JSON.parse($.cookie("group_groupbanner_collapsed"));
  }
  if(!$.cookie("group_groupbanner_collapsed") && settings.group_collapsible && settings.group_default_collapsed_state == "collapsed" || collapsedCookie && collapsedCookie.collapsed == "true") {
    $('#groupbanner-content_wrap').addClass("hidden");
    $('.d-icon-chevron-down').removeClass("hidden");
    $('.d-icon-chevron-up').addClass("hidden");
  }
  else {
    $('#groupbanner-content_wrap').removeClass("hidden");
    $('.d-icon-chevron-down').addClass("hidden");
    $('.d-icon-chevron-up').removeClass("hidden");
  }
}
function addClickEvents(cookieExpDate) {
  $('.groupbanner-box .close').click(function() {
    $(".groupbanner-box").addClass("hidden");
    if(cookieExpDate) {
      let groupbannerState = { name: settings.group_cookie_name, closed: "true" };
      $.cookie("groupbanner_closed", JSON.stringify(groupbannerState), { expires: cookieExpDate, path: '/' });
    }
  });
  $(".groupbanner-box .toggle").click(function() {
    $("#groupbanner-content_wrap").slideToggle();
    $('.d-icon-chevron-down').toggle();
    $('.d-icon-chevron-up').toggle();
    if(cookieExpDate) {
      let groupbannerState;
      if($.cookie("group_groupbanner_collapsed")) {
        groupbannerState = JSON.parse($.cookie('group_groupbanner_collapsed'));
        groupbannerState.name = settings.group_cookie_name;
        if(groupbannerState.collapsed == "false") {
          groupbannerState.collapsed = "true";
        } else {
          groupbannerState.collapsed = "false";
        }
      } else {
        if(settings.group_default_collapsed_state == "collapsed") {
          groupbannerState = { name: settings.group_cookie_name, collapsed: "false" }
        } else {
          groupbannerState = { name: settings.group_cookie_name, collapsed: "true" }
        }
      }
      $.cookie("group_groupbanner_collapsed", JSON.stringify(groupbannerState), { expires: cookieExpDate, path: '/' });
    }
  });
}

api.modifyClass("component:site-header", { 
  didInsertElement: function() {
    this._group();
    let rawDate = moment(settings.group_cookie_expiration_date);
    if (rawDate.isValid()) {
      let cookieExpDate = rawDate.toDate();
      setCurrentExpDate(cookieExpDate);
      addClickEvents(cookieExpDate);
    } else {
      $.removeCookie("group_groupbanner_closed", {path: '/'} );
      $.removeCookie("group_groupbanner_collapsed", {path: '/'} );
      addClickEvents(false);
    }
    setupgroupbanner();
  }
});

</script>

<script type="text/x-handlebars" data-template-name="/connectors/custom-banner/banner">
  <section class="groupbanner-box">
  <div class="button-container">
    {{#if (theme-setting 'group_dismissible')}}
    <button type="button" class="close">
      {{d-icon 'times'}}
    </button>
    {{/if}}
    {{#if (theme-setting 'group_collapsible')}}
    <button type="button" class="toggle">
      {{d-icon 'chevron-down'}}{{d-icon 'chevron-up'}}
    </button>
    {{/if}}
  </div>
    <div class="container">
      <div class="section-header">
        {{{theme-setting 'group_main_heading_content'}}}
      </div>
      <div id="groupbanner-content_wrap">
        <div class="row">
          {{#if (theme-setting 'group_first_column_content')}}
          <div class="first_column single-box">
            {{#if (theme-setting 'group_first_column_icon')}}
              {{mount-widget widget="groupbanner-column-icon" args=(hash column=0)}}
            {{/if}}
            <div>{{{theme-setting 'group_first_column_content'}}}</div>
          </div>
          {{/if}}
          {{#if (theme-setting 'group_second_column_content')}}
          <div class="second_column single-box">
            {{#if (theme-setting 'group_second_column_icon')}}
              {{mount-widget widget="groupbanner-column-icon" args=(hash column=1)}}
            {{/if}}
            <div>{{{theme-setting 'group_second_column_content'}}}</div>
          </div>
          {{/if}}
          {{#if (theme-setting 'group_third_column_content')}}
          <div class="third_column single-box">
            {{#if (theme-setting 'group_third_column_icon')}}
              {{mount-widget widget="groupbanner-column-icon" args=(hash column=2)}}
            {{/if}}
            <div>{{{theme-setting 'group_third_column_content'}}}</div>
          </div>
          {{/if}}
          {{#if (theme-setting 'group_fourth_column_content')}}
          <div class="fourth_column single-box">
            {{#if (theme-setting 'group_fourth_column_icon')}}
              {{mount-widget widget="groupbanner-column-icon" args=(hash column=3)}}
            {{/if}}
            <div>{{{theme-setting 'group_fourth_column_content'}}}</div>
          </div>
          {{/if}}
        </div>
      </div>
    </div>
  </section>
</script>

<script type="text/x-handlebars" data-template-name="/connectors/above-main-container/banner-themes">
  {{#if (theme-setting 'group_show_for_members')}}
    {{#if currentUser}}
      {{plugin-outlet name="custom-groupbanner"}}
    {{/if}}
  {{/if}}
  {{#if (theme-setting 'group_show_for_anon')}}
    {{#unless currentUser}}
      {{plugin-outlet name="custom-groupbanner"}}
    {{/unless}}
  {{/if}}
</script>

